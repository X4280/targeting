<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Client ➜ Targeting Lookup</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Prevent accidental selection of non‑copy columns */
      td.select-none,
      th.select-none {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <!-- React + React‑DOM (production builds) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Babel (compile JSX in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- App code (static CSV in repo) -->
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const CSV_URL = "clients.csv"; // CSV lives next to this file on Vercel

      async function loadClients() {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        return new Promise((resolve) => {
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: ({ data }) => {
              const cleaned = data
                .filter((row) => row.Client && row.Targetting)
                .map((row) => {
                  const excludeFlag = (row.Exclude || row.exclude || row.Type || "")
                    .toString()
                    .toLowerCase()
                    .includes("exclude");
                  return {
                    name: row.Client.trim(),
                    location: row.Targetting.trim(),
                    radius: row.Radius?.trim() || null,
                    exclude: excludeFlag,
                  };
                });
              resolve(cleaned);
            },
          });
        });
      }

      function App() {
        const [clients, setClients] = useState([]);
        const [query, setQuery] = useState("");
        const [copiedInclude, setCopiedInclude] = useState(false);
        const [copiedExclude, setCopiedExclude] = useState(false);
        const [copiedRow, setCopiedRow] = useState(null); // track clicked radius row index
        const [showSuggestions, setShowSuggestions] = useState(false);
        const inputRef = useRef(null);

        useEffect(() => {
          loadClients().then(setClients);
        }, []);

        // List of unique client names
        const uniqueClients = React.useMemo(() => {
          return Array.from(new Set(clients.map((c) => c.name))).sort();
        }, [clients]);

        // Suggestions based on current query
        const suggestions = query
          ? uniqueClients.filter((n) => n.toLowerCase().includes(query.toLowerCase())).slice(0, 10)
          : uniqueClients.slice(0, 10);

        // Filter dataset by query (exact match or substring) – same as before
        const filtered = clients.filter((c) =>
          c.name.toLowerCase().includes(query.toLowerCase())
        );

        // Grouped rows
        const radiusRows = filtered.filter((c) => c.radius && !c.exclude);
        const includedRows = filtered.filter((c) => !c.radius && !c.exclude);
        const excludedRows = filtered.filter((c) => c.exclude);

        const orderedRows = [...radiusRows, ...includedRows, ...excludedRows];

        const copyRows = (rows, setFlag) => {
          if (rows.length === 0) return;
          navigator.clipboard.writeText(rows.map((c) => c.location).join("\n"));
          setFlag(true);
          setTimeout(() => setFlag(false), 2000);
        };

        const handleRadiusClick = (idx, location) => {
          navigator.clipboard.writeText(location);
          setCopiedRow(idx);
          setTimeout(() => setCopiedRow(null), 1500);
        };

        const handleSuggestionClick = (name) => {
          setQuery(name);
          setShowSuggestions(false);
          // Focus out of the input so dropdown closes
          inputRef.current?.blur();
        };

        // Close suggestions on outside click
        useEffect(() => {
          function handleClick(e) {
            if (!inputRef.current) return;
            if (!inputRef.current.contains(e.target)) {
              setShowSuggestions(false);
            }
          }
          document.addEventListener("click", handleClick);
          return () => document.removeEventListener("click", handleClick);
        }, []);

        return (
          <main className="min-h-screen flex flex-col items-center p-8 gap-8">
            <h1 className="text-3xl font-bold text-slate-800">Client ➜ Targeting Lookup</h1>

            <div className="relative w-full max-w-md" ref={inputRef}>
              <input
                type="text"
                placeholder="Start typing client name…"
                value={query}
                onChange={(e) => {
                  setQuery(e.target.value);
                  setShowSuggestions(true);
                }}
                onFocus={() => setShowSuggestions(true)}
                className="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sky-400"
              />

              {showSuggestions && suggestions.length > 0 && (
                <ul className="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-lg border border-slate-200 bg-white shadow-lg">
                  {suggestions.map((name) => (
                    <li
                      key={name}
                      onClick={() => handleSuggestionClick(name)}
                      className="cursor-pointer px-4 py-2 hover:bg-slate-100"
                    >
                      {name}
                    </li>
                  ))}
                </ul>
              )}
            </div>

            {query && (
              <div className="w-full max-w-2xl">
                <div className="flex flex-wrap gap-4 mb-4">
                  {includedRows.length > 0 && (
                    <button
                      onClick={() => copyRows(includedRows, setCopiedInclude)}
                      className="inline-flex items-center gap-2 rounded-lg bg-sky-600 px-4 py-2 font-medium text-white transition hover:bg-sky-700 focus:outline-none"
                    >
                      {copiedInclude ? "Copied!" : "Copy locations"}
                    </button>
                  )}

                  {excludedRows.length > 0 && (
                    <button
                      onClick={() => copyRows(excludedRows, setCopiedExclude)}
                      className="inline-flex items-center gap-2 rounded-lg bg-rose-600 px-4 py-2 font-medium text-white transition hover:bg-rose-700 focus:outline-none"
                    >
                      {copiedExclude ? "Copied!" : "Copy EXCLUDES"}
                    </button>
                  )}
                </div>

                {orderedRows.length > 0 ? (
                  <table className="w-full text-left border-collapse shadow-lg rounded-lg overflow-hidden">
                    <thead>
                      <tr className="bg-sky-100">
                        <th className="p-3 select-none">Client</th>
                        <th className="p-3">Location</th>
                        <th className="p-3 select-none">Status / Radius</th>
                      </tr>
                    </thead>
                    <tbody>
                      {orderedRows.map((c, idx) => {
                        const isRadius = c.radius && !c.exclude;
                        const baseRow = idx % 2 === 0 ? "bg-white" : "bg-slate-50/60";
                        const excludeRow = c.exclude ? "bg-rose-50 border-l-4 border-rose-500" : "";
                        const radiusRow = isRadius ? "bg-emerald-50 border-l-4 border-emerald-500 cursor-pointer hover:bg-emerald-100" : "";
                        const rowClass = `${baseRow} ${excludeRow || radiusRow}`;

                        const locationColor = c.exclude
                          ? "text-rose-700"
                          : isRadius
                          ? "text-emerald-700"
                          : "text-slate-700";

                        return (
                          <tr
                            key={idx}
                            className={rowClass}
                            onClick={() => isRadius && handleRadiusClick(idx, c.location)}
                          >
                            <td className="p-3 font-medium text-slate-800 whitespace-nowrap select-none">
                              {c.name}
                            </td>
                            <td className={`p-3 ${locationColor} select-text`}>{c.location}</td>
                            <td className="p-3 select-none">
                              {c.exclude ? (
                                <span className="inline-block rounded-full bg-rose-100 px-2 py-0.5 text-xs font-semibold text-rose-700 uppercase tracking-wide">
                                  Exclude
                                </span>
                              ) : isRadius ? (
                                <span className="inline-block rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-semibold text-emerald-700 tracking-wide">
                                  {copiedRow === idx ? "Copied!" : c.radius}
                                </span>
                              ) : (
                                "—"
                              )}
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                ) : (
                  <p className="text-slate-500 mt-4">No matches found.</p>
                )}
              </div>
            )}
          </main>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
