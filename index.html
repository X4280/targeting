"use client";
import { useState, useEffect } from "react";
import Papa from "papaparse";

// Fetch + parse the master CSV stored in /public/clients.csv
async function loadClients() {
  const res = await fetch("/clients.csv"); // served from /public
  const text = await res.text();
  return new Promise((resolve) => {
    Papa.parse(text, {
      header: true,
      complete: (results) => {
        const cleaned = results.data
          .filter((row) => row.Client && row.Targetting)
          .map((row) => ({
            name: row.Client.trim(),
            location: row.Targetting.trim(),
            radius: row.Radius?.trim() || null,
          }));
        resolve(cleaned);
      },
    });
  });
}

export default function Page() {
  const [clients, setClients] = useState([]);
  const [query, setQuery] = useState("");
  const [copied, setCopied] = useState(false);

  useEffect(() => {
    loadClients().then(setClients);
  }, []);

  const filtered = clients.filter((c) =>
    c.name.toLowerCase().includes(query.toLowerCase())
  );

  // ZIP / County rows ⇒ no radius value
  const eligible = filtered.filter((c) => !c.radius);

  const handleCopy = () => {
    if (eligible.length === 0) return;
    navigator.clipboard.writeText(eligible.map((c) => c.location).join("\n"));
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <main className="min-h-screen bg-slate-50 flex flex-col items-center p-8 gap-8">
      <h1 className="text-3xl font-bold text-slate-800">
        Client ➜ Targeting Lookup
      </h1>

      <input
        type="text"
        placeholder="Type client name (e.g. Essential)"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        className="w-full max-w-md rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sky-400"
      />

      {query && (
        <div className="w-full max-w-2xl">
          {eligible.length > 0 && (
            <button
              onClick={handleCopy}
              className="mb-4 inline-flex items-center gap-2 rounded-lg bg-sky-600 px-4 py-2 font-medium text-white transition hover:bg-sky-700 focus:outline-none"
            >
              {copied ? "Copied!" : "Copy locations"}
            </button>
          )}

          {filtered.length > 0 ? (
            <table className="w-full text-left border-collapse shadow-lg">
              <thead>
                <tr className="bg-sky-100">
                  <th className="p-3">Client</th>
                  <th className="p-3">Location</th>
                  <th className="p-3">Radius</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map((c, idx) => (
                  <tr
                    key={idx}
                    className={
                      idx % 2 === 0 ? "bg-white" : "bg-slate-50/60"
                    }
                  >
                    <td className="p-3 font-medium text-slate-800">{c.name}</td>
                    <td className="p-3 text-slate-700">{c.location}</td>
                    <td className="p-3 text-slate-700">
                      {c.radius ? c.radius : "—"}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          ) : (
            <p className="text-slate-500 mt-4">No matches found.</p>
          )}
        </div>
      )}
    </main>
  );
}
